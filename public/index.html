<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Projeto Integrador II - Demo</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, sans-serif;
        margin: 2rem;
      }
      header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }
      .badge {
        background: #0ea5e9;
        color: #fff;
        padding: 0.2rem 0.5rem;
        border-radius: 0.4rem;
        font-size: 0.8rem;
      }
      .card {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1rem;
        max-width: 640px;
      }
      button {
        background: #111827;
        color: #fff;
        border: none;
        padding: 0.6rem 1rem;
        border-radius: 0.4rem;
        cursor: pointer;
      }
      button:hover {
        background: #374151;
      }
      code {
        background: #f3f4f6;
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
      }
      footer {
        margin-top: 2rem;
        color: #6b7280;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Projeto Integrador II</h1>
      <span class="badge">Node.js + Express</span>
    </header>

    <div class="card">
      <p>Front-end estático servido pelo Express. Teste a API:</p>
      <p>
        <button id="btn">Chamar /api/hello</button>
      </p>
      <pre id="out">Clique para chamar a API…</pre>
    </div>

    <div class="card" style="margin-top:1rem;">
      <h3>Notas (MongoDB)</h3>
      <form id="note-form" style="display:flex; gap:.5rem; margin-bottom:.5rem;">
        <input id="title" placeholder="Título" required />
        <input id="content" placeholder="Conteúdo" />
        <button type="submit">Adicionar</button>
      </form>
      <pre id="notes">Carregando notas...</pre>
    </div>

    <footer>
      <p>Endpoints úteis: <code>/api/health</code> e <code>/api/hello</code></p>
    </footer>

    <script>
      document.getElementById("btn").addEventListener("click", async () => {
        const out = document.getElementById("out");
        out.textContent = "Carregando...";
        try {
          const res = await fetch("/api/hello");
          const data = await res.json();
          out.textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          out.textContent = "Erro ao chamar API: " + err.message;
        }
      });

      async function loadNotes() {
        const el = document.getElementById('notes');
        el.textContent = 'Carregando notas...';
        try {
          const res = await fetch('/api/notes');
          const data = await res.json();
          if (!Array.isArray(data)) throw new Error('Resposta inesperada');
          el.textContent = '';
          const list = document.createElement('div');
          data.forEach(n => {
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.gap = '.5rem';
            row.style.alignItems = 'center';
            row.style.marginBottom = '.25rem';
            const text = document.createElement('span');
            text.textContent = `${n.title} — ${n.content || ''}`;
            const del = document.createElement('button');
            del.textContent = 'Excluir';
            del.onclick = async () => {
              try {
                const r = await fetch(`/api/notes/${n._id}`, { method: 'DELETE' });
                if (!r.ok) {
                  const body = await r.json().catch(() => ({}));
                  throw new Error(body.error || 'Erro ao excluir');
                }
                await loadNotes();
              } catch (e) { alert('Erro ao excluir: ' + e.message); }
            };
            const edit = document.createElement('button');
            edit.textContent = 'Editar';
            edit.onclick = async () => {
              const newTitle = prompt('Novo título', n.title);
              if (newTitle == null) return; // cancel
              const newContent = prompt('Novo conteúdo', n.content || '');
              try {
                const r = await fetch(`/api/notes/${n._id}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ title: newTitle, content: newContent })
                });
                const body = await r.json().catch(() => ({}));
                if (!r.ok) throw new Error(body.error || 'Erro ao atualizar');
                await loadNotes();
              } catch (e) { alert('Erro ao atualizar: ' + e.message); }
            };
            row.appendChild(text);
            row.appendChild(edit);
            row.appendChild(del);
            list.appendChild(row);
          });
          el.appendChild(list);
        } catch (err) {
          el.textContent = 'Notas indisponíveis: ' + err.message + '\nDica: configure MONGODB_URI no servidor.';
        }
      }

      document.getElementById('note-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const title = document.getElementById('title').value.trim();
        const content = document.getElementById('content').value.trim();
        if (!title) return alert('Título é obrigatório');
        try {
          const res = await fetch('/api/notes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, content })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Erro ao salvar');
          document.getElementById('title').value = '';
          document.getElementById('content').value = '';
          await loadNotes();
        } catch (err) {
          alert('Erro: ' + err.message + '\nDica: verifique se o banco está conectado');
        }
      });

      loadNotes();
    </script>
  </body>
</html>
